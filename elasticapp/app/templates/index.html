{% extends 'base.html' %}

{% block content %}

	<!--  Bootstrap navigation bar -->
<script type="text/javascript">
	var timeline_data = {{ data.timeline|tojson }};
</script>
<nav class="navbar navbar-light bg-light material">
		<!-- <a class="navbar-brand">The Elastic 4</a> -->
		<form class="form-inline" action="/search">
  		<input class="form-control" type="search" placeholder="Search" name="search" value="{{ data.search_term }}"aria-label="Search">
		</form>
</nav>

{% if data.results != None %}
<div id="timeline-wrapper" class="container">
	<h1>Timeline</h1>
  	<div id="timeline"></div>
</div>
<div class="container search-results">
	<span class="text-center">Showing results {{ data.range }} from {{ data.count }}</span>
	{% for q in data.results %}
	<div class="row justify-content-center">
    <div class="card text-center material">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
          <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#question-{{q.questionId}}">Question</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#answers-{{q.questionId}}">Answers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link stat-link" data-toggle="tab" href="#statistics-{{q.questionId}}">Statistics</a>
          </li>
        </ul>
      </div>
      <div class="card-body tab-content">
        <div class="tab-pane question-pane fade show active" id="question-{{q.questionId}}" role="tabpanel">
          <h5 class="card-title">{{q.question}}</h5>
          <p class="card-text">{{q.description}}</p>
			  	<p class="card-text"><small class="text-muted">By user nr. {{ q.user.userId }} on {{q.date}}</small></p>
        </div>
        <div class="tab-pane answer-pane fade" id="answers-{{q.questionId}}" role="tabpanel">
          <h5 class="card-title">Answers</h5>
			  	{% if q.answers|length != 0 %}
			  		<ul class="list-group list-group-flush">
			  		{% for a in q.answers %}
			  			<li class="list-group-item">
			  				<p class="card-text">{{a.answer}}</p>
			  				<p class="card-text"><small class="text-muted">By user nr. {{ a.user.userId }} on {{a.date}}</small></p>
			  				<span class="badge badge-success">+{{ a.thumbsUp }}</span>
			  				<span class="badge badge-danger">-{{ a.thumbsDown }}</span>
		  	  		</li>
			  		{% endfor %}
		  			</ul>
			  	{% else %}
			  		<p class="card-text">Geen antwoorden gevonden</p>
			  	{% endif %}
        </div>
        <div class="tab-pane fade statistics-pane" id="statistics-{{q.questionId}}" role="tabpanel">
          <h5 class="card-title">Statistics</h5>
		  		{% if q.answers|length != 0 %}
							<div class="widget">
			  			<div class="wordcloud-data" data-wordcloud="{{ data.wordcloud[q.questionId] }}" data-id="#chart-{{q.questionId}}">
	      				<div id="chart-{{q.questionId}}"></div>
		  				</div>
						</div>
					{% else %}
		 				<p class="card-text">Geen antwoorden gevonden</p>
					{% endif %}
        </div>
     	</div>
    </div>
	</div>
  <br>
  {% endfor %}
  <div class="pagination"><a href=""></a></div>
</div>

<!-- WORD CLOUD -->
<script>

$(document).ready(function(){
	$('.stat-link').click(function(){
		console.log(this)
		var text = $(this).attr('href')
		var wordcloud_text = $(this).parents('.card').find(text).find(".wordcloud-data").attr("data-wordcloud")
		var wordcloud_div_id = $(this).parents('.card').find(text).find(".wordcloud-data").attr("data-id")

		drawWordCloud(wordcloud_text, wordcloud_div_id)
	})
})


	    function drawWordCloud(text_string,location){
	      var common = "\\";
	      var word_count = {};
	      var words = text_string.split(/[ '\-\(\)\*":;\[\]|{},.!?]+/);
	        if (words.length == 1){
	          word_count[words[0]] = 1;
	        } else {
	          words.forEach(function(word){
	            var word = word.toLowerCase();
	            if (word != "" && common.indexOf(word)==-1 && word.length>1){
	              if (word_count[word]){
	                word_count[word]++;
	              } else {
	                word_count[word] = 1;
	              }
	            }
	          })
	        }

	      var svg_location = location;
	      var width = 500;
	      var height = width;

	      var fill = d3.scale.category20();

	      var word_entries = d3.entries(word_count);

	      var xScale = d3.scale.linear()
	         .domain([0, d3.max(word_entries, function(d) {
	            return d.value;
	          })
	         ])
	         .range([10,100]);

		  console.log(text_string)
		  console.log(location)
		  console.log(words)

	      d3.layout.cloud().size([width, height])
			.timeInterval(20)
	        .words(word_entries)
	        .fontSize(function(d) { return xScale(+d.value); })
	        .text(function(d) { return d.key; })
	        .rotate(function() { return ~~(Math.random() * 2) * 90; })
	        .font("Impact")
	        .on("end", draw)
	        .start();

		  console.log("test3")

	      function draw(words) {
	        d3.select(svg_location).append("svg")
	            .attr("width", width)
	            .attr("height", height)
	          .append("g")
	            .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
	          .selectAll("text")
	            .data(words)
	          .enter().append("text")
	            .style("font-size", function(d) { return xScale(d.value) + "px"; })
	            .style("font-family", "Impact")
	            .style("fill", function(d, i) { return fill(i); })
	            .attr("text-anchor", "middle")
	            .attr("transform", function(d) {
	              return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
	            })
	            .text(function(d) { return d.key; });
	      }

	      d3.layout.cloud().stop();
    }
  </script>
  {% endif %}

{% endblock %}
